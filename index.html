<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è¯¾å ‚å®‰é™ç¥å™¨ - HTML å¤åˆ»ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #5b3200 0, #180b02 55%, #050100 100%);
      color: #ffd96a;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 1000px;
      background: linear-gradient(160deg, #3a1a02 0, #1e0d02 40%, #1a0b01 100%);
      border-radius: 24px;
      padding: 24px 32px 32px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 199, 64, 0.15);
    }

    header {
      text-align: center;
      font-size: 24px;
      letter-spacing: 4px;
      margin-bottom: 18px;
      color: #ffe88a;
      text-shadow: 0 0 20px rgba(255, 217, 106, 0.7);
    }

    .top-panel {
      display: flex;
      align-items: flex-end;
      gap: 16px;
      padding: 14px 18px;
      background: radial-gradient(circle at top, #4b2606 0, #2a1404 55%);
      border-radius: 16px;
      border: 1px solid rgba(255, 204, 102, 0.25);
      margin-bottom: 20px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 120px;
    }

    .field label {
      font-size: 12px;
      color: #f9dca0;
      opacity: 0.9;
    }

    .field input {
      background: rgba(0, 0, 0, 0.35);
      border-radius: 999px;
      border: 1px solid rgba(255, 217, 106, 0.4);
      padding: 6px 10px;
      color: #ffe9aa;
      font-size: 13px;
      outline: none;
    }

    .field input:focus {
      box-shadow: 0 0 0 1px rgba(255, 217, 106, 0.6);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
        background 0.08s ease-out;
      white-space: nowrap;
    }

    #startBtn {
      margin-left: auto;
      background: linear-gradient(135deg, #ffdf73 0, #ffb92b 100%);
      color: #5a3100;
      font-weight: 600;
      box-shadow: 0 0 18px rgba(255, 204, 102, 0.55);
    }

    #startBtn.running {
      background: linear-gradient(135deg, #ffb22e 0, #ff8b2b 100%);
      color: #2b1300;
    }

    #resetBtn {
      background: rgba(0, 0, 0, 0.4);
      color: #f5d597;
      border: 1px solid rgba(255, 217, 106, 0.4);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .main {
      display: grid;
      grid-template-columns: 1.1fr 1.4fr;
      gap: 18px;
      margin-top: 4px;
    }

    /* å·¦ä¾§å¤§åˆ†æ•° */
    .score-panel {
      background: radial-gradient(circle at top, #422008 0, #210c03 60%);
      border-radius: 18px;
      padding: 28px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255, 189, 74, 0.3);
      position: relative;
      overflow: hidden;
    }

    .score-panel::before {
      content: "è¯¾å ‚å®‰é™ç¥å™¨";
      position: absolute;
      top: 26px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 22px;
      letter-spacing: 4px;
      color: rgba(255, 233, 170, 0.1);
      white-space: nowrap;
    }

    .score-value {
      font-size: 80px;
      font-weight: 700;
      color: #ffdd71;
      text-shadow: 0 0 24px rgba(255, 220, 120, 0.9);
    }

    .score-unit {
      margin-top: 4px;
      font-size: 18px;
      color: #f5c96a;
    }

    .score-sub {
      margin-top: 16px;
      font-size: 13px;
      color: rgba(255, 233, 170, 0.8);
    }

    .score-sub span {
      color: #ffdd80;
      font-weight: 500;
    }

    /* ä¸­é—´ / å³ä¾§éƒ¨åˆ† */
    .center-panel {
      background: radial-gradient(circle at top, #43210a 0, #220e05 60%);
      border-radius: 18px;
      padding: 18px 20px 20px;
      border: 1px solid rgba(255, 199, 96, 0.3);
      display: grid;
      grid-template-rows: auto auto 1fr auto auto;
      gap: 8px;
    }

    .time-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .timer-block {
      flex: 1;
      background: rgba(0, 0, 0, 0.35);
      border-radius: 12px;
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(255, 217, 106, 0.25);
    }

    .timer-label {
      font-size: 12px;
      color: #f8dca5;
      opacity: 0.9;
    }

    .timer-value {
      font-size: 20px;
      letter-spacing: 2px;
      color: #ffe9ab;
    }

    .gauge-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: 4px;
      padding-bottom: 6px;
    }

    .gauge {
      width: 170px;
      height: 170px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 10%, #fffbde 0, #ffdf7b 20%, #c47a09 55%, #2a1205 100%);
      position: relative;
      box-shadow: 0 0 26px rgba(255, 207, 110, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gauge-inner {
      width: 65%;
      height: 65%;
      border-radius: 50%;
      background: radial-gradient(circle at top, #2a1204 0, #150702 60%);
      box-shadow: inset 0 0 16px rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #ffe8a2;
      font-size: 12px;
      text-align: center;
    }

    .gauge-db {
      margin-top: 4px;
      font-size: 22px;
      font-weight: 600;
    }

    .needle {
      position: absolute;
      width: 50%;
      height: 3px;
      background: #ffeede;
      left: 50%;
      top: 50%;
      transform-origin: 10% 50%;
      transform: rotate(-120deg);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
      border-radius: 999px;
    }

    .needle::after {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: radial-gradient(circle, #fff8e2 0, #ffcf62 60%, #b56a00 100%);
      left: -6px;
      top: -5.5px;
      box-shadow: 0 0 10px rgba(255, 222, 128, 0.8);
    }

    .threshold-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.35);
      border-radius: 12px;
      border: 1px solid rgba(255, 217, 106, 0.25);
    }

    .threshold-value {
      font-weight: 600;
      color: #ffe38f;
    }

    .status {
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 10px;
      margin-top: 4px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(140, 255, 158, 0.25);
      color: #bbffbb;
    }

    .status.bad {
      border-color: rgba(255, 153, 153, 0.45);
      color: #ffbbbb;
    }

    .bottom-hint {
      margin-top: 3px;
      font-size: 12px;
      color: rgba(255, 230, 190, 0.7);
      text-align: right;
    }

    .warning {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255, 168, 168, 0.9);
    }

    @media (max-width: 780px) {
      .app {
        padding: 18px 16px 22px;
      }

      .top-panel {
        flex-wrap: wrap;
      }

      #startBtn {
        margin-left: 0;
      }

      .main {
        grid-template-columns: 1fr;
      }

      .score-panel {
        order: 2;
      }

      .center-panel {
        order: 1;
      }

      .score-value {
        font-size: 64px;
      }

      .gauge {
        width: 150px;
        height: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>æ¯ä¸€ç§’éƒ½åœ¨è¿›æ­¥</header>

    <div class="top-panel">
      <div class="field">
        <label>ç›®æ ‡åˆ†æ•°</label>
        <input id="targetScore" type="number" value="100" min="1" />
      </div>
      <div class="field">
        <label>ä¸Šè¯¾æ—¶é—´</label>
        <input id="startTime" type="time" value="08:30" />
      </div>
      <div class="field">
        <label>ä¸‹è¯¾æ—¶é—´</label>
        <input id="endTime" type="time" value="09:15" />
      </div>
      <div class="field">
        <label>å®‰é™åˆ†è´</label>
        <input id="quietThreshold" type="number" value="30" min="10" max="90" />
      </div>
      <button id="startBtn">å¼€å§‹å­¦ä¹ </button>
      <button id="resetBtn">é‡ç½®</button>
    </div>

    <div class="main">
      <!-- å·¦ä¾§å¾—åˆ†å¤§å± -->
      <div class="score-panel">
        <div id="scoreValue" class="score-value">0.00</div>
        <div class="score-unit">åˆ†</div>
        <div class="score-sub">
          å½“å‰ä¸Šè¯¾å®‰é™å¾—åˆ†ï¼š<span id="scoreDesc">ä¿æŒå®‰é™å³å¯å¿«é€Ÿå¾—åˆ†</span>
        </div>
      </div>

      <!-- ä¸­å¿ƒ + å³ä¾§ -->
      <div class="center-panel">
        <div class="time-row">
          <div class="timer-block">
            <div class="timer-label">å·²å­¦ä¹ æ—¶é—´</div>
            <div id="elapsedTime" class="timer-value">00:00:00</div>
          </div>
          <div class="timer-block">
            <div class="timer-label">å‰©ä½™æ—¶é—´</div>
            <div id="remainingTime" class="timer-value">00:45:00</div>
          </div>
        </div>

        <div class="gauge-wrapper">
          <div class="gauge">
            <div class="needle" id="needle"></div>
            <div class="gauge-inner">
              <div>å½“å‰åˆ†è´</div>
              <div id="currentDb" class="gauge-db">--</div>
            </div>
          </div>
        </div>

        <div class="threshold-row">
          <span>åˆ†è´é™åˆ¶</span>
          <span class="threshold-value" id="thresholdLabel">30 dB</span>
        </div>

        <div id="status" class="status">
          å½“å‰ç¯å¢ƒå¾ˆå®‰é™ï¼Œè¯·ç»§ç»­ä¿æŒ ğŸ‘
        </div>

        <div class="bottom-hint">
          å®‰é™è¶Šä¹…ï¼Œå¾—åˆ†è¶Šé«˜ï¼›å™ªéŸ³è¶…æ ‡åˆ™æš‚åœè®¡åˆ†
        </div>

        <div id="micWarning" class="warning" style="display:none;">
          æµè§ˆå™¨æœªèƒ½è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥ï¼šæ˜¯å¦æˆäºˆæƒé™ / æ˜¯å¦ä½¿ç”¨ https æˆ–æœ¬åœ°æ–‡ä»¶ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- DOM å…ƒç´  ----
    const targetScoreInput = document.getElementById("targetScore");
    const startTimeInput = document.getElementById("startTime");
    const endTimeInput = document.getElementById("endTime");
    const quietThresholdInput = document.getElementById("quietThreshold");

    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");

    const scoreValueEl = document.getElementById("scoreValue");
    const scoreDescEl = document.getElementById("scoreDesc");

    const elapsedTimeEl = document.getElementById("elapsedTime");
    const remainingTimeEl = document.getElementById("remainingTime");

    const needleEl = document.getElementById("needle");
    const currentDbEl = document.getElementById("currentDb");
    const thresholdLabelEl = document.getElementById("thresholdLabel");
    const statusEl = document.getElementById("status");
    const micWarningEl = document.getElementById("micWarning");

    // ---- è®¡æ—¶ä¸å¾—åˆ†çŠ¶æ€ ----
    let isRunning = false;
    let totalSeconds = 45 * 60; // é»˜è®¤ 45 åˆ†é’Ÿ
    let elapsedMs = 0;
    let lastTickTime = null;
    let quietSeconds = 0;
    let targetScore = 100;
    let quietThreshold = 30;

    // ---- éŸ³é¢‘ç›¸å…³ ----
    let audioContext = null;
    let analyser = null;
    let dataArray = null;
    let micStream = null;
    let lastDb = null;
    let soundIntervalId = null;

    // æ ¼å¼åŒ–æ—¶é—´ï¼šç§’ -> HH:MM:SS
    function formatTime(seconds) {
      const s = Math.max(0, Math.floor(seconds));
      const h = String(Math.floor(s / 3600)).padStart(2, "0");
      const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
      const sec = String(s % 60).padStart(2, "0");
      return `${h}:${m}:${sec}`;
    }

    // è®¡ç®—ä¸Šè¯¾æ—¶é•¿ï¼ˆæ ¹æ®ä¸Š/ä¸‹è¯¾æ—¶é—´ï¼‰
    function computeTotalSecondsFromTime() {
      const st = startTimeInput.value || "08:30";
      const et = endTimeInput.value || "09:15";
      const [sh, sm] = st.split(":").map(Number);
      const [eh, em] = et.split(":").map(Number);
      let start = sh * 60 + sm;
      let end = eh * 60 + em;
      if (isNaN(start) || isNaN(end)) return 45 * 60;
      if (end <= start) {
        // é˜²æ­¢è€å¸ˆå†™é”™æ—¶é—´ï¼Œå…¼å®¹ä¸€ä¸‹ï¼Œæœ€å°‘ 30 åˆ†é’Ÿ
        return 45 * 60;
      }
      const diffMin = end - start;
      return Math.max(diffMin * 60, 10 * 60); // ä¸å°‘äº 10 åˆ†é’Ÿ
    }

    // æ ¹æ®åˆ†è´æ›´æ–°ä»ªè¡¨ç›˜æŒ‡é’ˆ
    function updateGauge(dbValue) {
      if (dbValue == null || isNaN(dbValue)) {
        currentDbEl.textContent = "--";
        needleEl.style.transform = "rotate(-120deg)";
        return;
      }
      const displayDb = Math.round(dbValue);
      currentDbEl.textContent = displayDb;

      // é™åˆ¶åœ¨ 0~80 dB ä¹‹é—´
      const minDb = 0;
      const maxDb = 80;
      const clamped = Math.max(minDb, Math.min(maxDb, dbValue));

      // ä»ªè¡¨ç›˜è§’åº¦èŒƒå›´ï¼š-120Â° ~ 120Â°
      const minAngle = -120;
      const maxAngle = 120;
      const ratio = (clamped - minDb) / (maxDb - minDb);
      const angle = minAngle + (maxAngle - minAngle) * ratio;
      needleEl.style.transform = `rotate(${angle}deg)`;
    }

    // åˆå§‹åŒ–éº¦å…‹é£ç›‘å¬
    async function initMic() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        micWarningEl.style.display = "block";
        micWarningEl.textContent =
          "å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ getUserMediaï¼Œæ— æ³•è·å–éº¦å…‹é£åˆ†è´ã€‚";
        return;
      }

      try {
        micWarningEl.style.display = "none";
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micStream = stream;
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 1024;
        const bufferLength = analyser.fftSize;
        dataArray = new Uint8Array(bufferLength);
        source.connect(analyser);

        // æ¯ 200ms è®¡ç®—ä¸€æ¬¡åˆ†è´
        if (soundIntervalId) clearInterval(soundIntervalId);
        soundIntervalId = setInterval(() => {
          if (!analyser) return;
          analyser.getByteTimeDomainData(dataArray);
          let sum = 0;
          for (let i = 0; i < dataArray.length; i++) {
            const v = (dataArray[i] - 128) / 128; // [-1,1]
            sum += v * v;
          }
          const rms = Math.sqrt(sum / dataArray.length);
          // è½¬æˆä¸€ä¸ªâ€œç›¸å¯¹åˆ†è´â€æ•°å­—ï¼Œç”¨æ¥æ˜¾ç¤ºå’Œæ¯”è¾ƒ
          // rms åœ¨ 0~1ï¼Œå–å¯¹æ•°åæ˜¯è´Ÿå€¼ï¼Œè¿™é‡Œäººä¸ºåç§»ä¸€ä¸‹åˆ° 0~80 é™„è¿‘
          let db;
          if (rms === 0) {
            db = 0;
          } else {
            const dbRaw = 20 * Math.log10(rms); // çº¦ -60 ~ 0
            db = Math.max(0, 60 + dbRaw); // è½¬æˆ 0~60 å·¦å³
          }
          lastDb = db;
          updateGauge(db);

          // æ›´æ–°çŠ¶æ€æ–‡æ¡ˆ
          if (!isRunning) return;
          if (db <= quietThreshold) {
            statusEl.classList.remove("bad");
            statusEl.textContent = "å½“å‰ç¯å¢ƒå¾ˆå®‰é™ï¼Œè¯·ç»§ç»­ä¿æŒ ğŸ‘";
          } else {
            statusEl.classList.add("bad");
            statusEl.textContent = "å½“å‰ç¯å¢ƒæœ‰ç‚¹åµï¼Œè¶…è¿‡å®‰é™åˆ†è´å•¦ï½";
          }
        }, 200);
      } catch (err) {
        micWarningEl.style.display = "block";
        micWarningEl.textContent =
          "æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å·²æˆäºˆæƒé™ã€‚ï¼ˆ" + err.message + "ï¼‰";
      }
    }

    // æ›´æ–°å¾—åˆ†å’Œæ—¶é—´æ˜¾ç¤º
    function updateUI() {
      const elapsedSeconds = elapsedMs / 1000;
      const remainingSeconds = Math.max(0, totalSeconds - elapsedSeconds);

      elapsedTimeEl.textContent = formatTime(elapsedSeconds);
      remainingTimeEl.textContent = formatTime(remainingSeconds);

      const rawScore =
        (quietSeconds / totalSeconds) * targetScore; // å®‰é™æ—¶é—´å æ¯” * ç›®æ ‡åˆ†
      const score = Math.min(targetScore, rawScore);
      scoreValueEl.textContent = score.toFixed(2);

      if (score >= targetScore * 0.9) {
        scoreDescEl.textContent = "å®‰é™åº¦æ»¡åˆ†ï¼Œè¯¾å ‚çºªå¾‹éå¸¸æ£’ï¼";
      } else if (score >= targetScore * 0.6) {
        scoreDescEl.textContent = "æ•´ä½“è¡¨ç°å¾ˆå¥½ï¼Œç»§ç»­ä¿æŒå°±èƒ½æ‹¿é«˜åˆ†ï½";
      } else {
        scoreDescEl.textContent = "å†å®‰é™ä¸€ç‚¹ç‚¹ï¼Œå¾—åˆ†ä¼šæ›´é«˜å“¦ï½";
      }
    }

    // åŠ¨ç”»å¾ªç¯
    function tick(timestamp) {
      if (!isRunning) return;
      if (lastTickTime == null) lastTickTime = timestamp;
      const delta = timestamp - lastTickTime;
      lastTickTime = timestamp;

      elapsedMs += delta;
      const elapsedSeconds = elapsedMs / 1000;

      if (lastDb != null && lastDb <= quietThreshold) {
        quietSeconds += delta / 1000;
      }

      if (elapsedSeconds >= totalSeconds) {
        elapsedMs = totalSeconds * 1000;
        isRunning = false;
        startBtn.classList.remove("running");
        startBtn.textContent = "å·²ç»“æŸ";
      }

      updateUI();

      if (isRunning) {
        requestAnimationFrame(tick);
      }
    }

    // å¼€å§‹/æš‚åœæŒ‰é’®
    startBtn.addEventListener("click", () => {
      if (!isRunning) {
        // é‡æ–°åˆå§‹åŒ–é…ç½®
        targetScore = Math.max(1, Number(targetScoreInput.value) || 100);
        quietThreshold = Math.max(
          5,
          Math.min(90, Number(quietThresholdInput.value) || 30)
        );
        thresholdLabelEl.textContent = `${quietThreshold} dB`;
        totalSeconds = computeTotalSecondsFromTime();

        if (elapsedMs >= totalSeconds * 1000) {
          // å·²ç»ç»“æŸè¿‡ä¸€è½®ï¼Œé‡æ–°å¼€å§‹
          elapsedMs = 0;
          quietSeconds = 0;
        }

        isRunning = true;
        lastTickTime = null;
        startBtn.classList.add("running");
        startBtn.textContent = "å­¦ä¹ ä¸­ Â· ç‚¹å‡»æš‚åœ";

        initMic(); // ç¡®ä¿éº¦å…‹é£å·²å°±ç»ª
        requestAnimationFrame(tick);
      } else {
        // æš‚åœ
        isRunning = false;
        startBtn.classList.remove("running");
        startBtn.textContent = "ç»§ç»­å­¦ä¹ ";
      }
    });

    // é‡ç½®æŒ‰é’®
    resetBtn.addEventListener("click", () => {
      isRunning = false;
      elapsedMs = 0;
      quietSeconds = 0;
      lastTickTime = null;
      lastDb = null;

      scoreValueEl.textContent = "0.00";
      scoreDescEl.textContent = "ä¿æŒå®‰é™å³å¯å¿«é€Ÿå¾—åˆ†";
      elapsedTimeEl.textContent = "00:00:00";
      totalSeconds = computeTotalSecondsFromTime();
      remainingTimeEl.textContent = formatTime(totalSeconds);
      currentDbEl.textContent = "--";
      updateGauge(null);
      statusEl.classList.remove("bad");
      statusEl.textContent = "å½“å‰ç¯å¢ƒå¾ˆå®‰é™ï¼Œè¯·ç»§ç»­ä¿æŒ ğŸ‘";
      thresholdLabelEl.textContent = `${quietThresholdInput.value || 30} dB`;

      startBtn.classList.remove("running");
      startBtn.textContent = "å¼€å§‹å­¦ä¹ ";
    });

    // åˆå§‹åŒ–é»˜è®¤å‰©ä½™æ—¶é—´æ˜¾ç¤º
    totalSeconds = computeTotalSecondsFromTime();
    remainingTimeEl.textContent = formatTime(totalSeconds);
    thresholdLabelEl.textContent = `${quietThresholdInput.value} dB`;

    // é¡µé¢åŠ è½½æ—¶å°±å°è¯•åˆå§‹åŒ–éº¦å…‹é£ï¼ˆæ–¹ä¾¿è€å¸ˆæå‰æˆæƒï¼‰
    window.addEventListener("load", () => {
      initMic();
    });
  </script>
</body>
</html>
